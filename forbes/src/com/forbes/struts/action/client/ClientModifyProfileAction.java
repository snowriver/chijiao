/*
 * Generated by MyEclipse Struts
 * Template path: templates/java/JavaClass.vtl
 */
package com.forbes.struts.action.client;

import java.util.Date;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import org.apache.struts.actions.DispatchAction;
import org.apache.struts.action.ActionForm;
import org.apache.struts.action.ActionForward;
import org.apache.struts.action.ActionMapping;

import com.forbes.hibernate.bean.UcMembers;
import com.forbes.hibernate.bean.User;
import com.forbes.hibernate.bean.UserDetail;
import com.forbes.mail.SendMailToRegister;
import com.forbes.service.client.ClientModifyProfile;
import com.forbes.service.user.UserInfoManager;
import com.forbes.service.user.UserLogin;
import com.forbes.struts.form.client.ClientModifyProfileForm;
import com.forbes.struts.form.user.UserRegisterForm;
import com.forbes.util.MD5;

/** 
 * MyEclipse Struts
 * Creation date: 07-09-2007
 * 
 * XDoclet definition:
 * @struts.action path="/client/ClientLogin" name="clientLoginForm" attribute="ClientLoginForm" input="/client/ClientLogin.jsp" scope="request" validate="true"
 * @struts.action-forward name="success" path="/client/ClientLoginOk.jsp"
 * @struts.action-forward name="fail" path="/client/ClientLoginFail.jsp"
 */
public class ClientModifyProfileAction extends DispatchAction {

	/*
	 * Generated Methods
	 */

	
	private  ClientModifyProfile clientModifyProfile;
	
	private UserInfoManager userInfoManager;
	
	
	/** 
	 * 客户登
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return ActionForward
	 */
	public ActionForward getdetail(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
		/*String id = request.getParameter("id");
		String m  = request.getParameter("m");*/
		
		UcMembers user = (UcMembers)request.getSession().getAttribute("CLIENT");
		
		try{
			//User user = userInfoManager.getUser( Integer.parseInt(id) );
			
			//System.out.println("User.id = " + user.getUid());
			//System.out.println("User.detail.id = " + user.getUserDetail().getId());
			//System.out.println("User.detail.QQ = " + user.getUserDetail().getQq());

			user = userInfoManager.initUserDetail(user);
			//UserDetail detail = clientModifyProfile.getUserDetail(user);
			UserDetail detail = user.getUserDetail();
			//System.out.println("User.detail.qq = " + detail.getQq());
			
			request.setAttribute("USER_DETAIL", detail);
			request.getSession().setAttribute("CLIENT", user);
			return mapping.findForward("modify");
		
		}catch( Exception e ){
			e.printStackTrace();
			return mapping.findForward("fail");
		}
	}


	public ClientModifyProfile getClientModifyProfile() {
		return clientModifyProfile;
	}


	public void setClientModifyProfile(ClientModifyProfile clientModifyProfile) {
		this.clientModifyProfile = clientModifyProfile;
	}
	

	public ActionForward modifydetail(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
 
		ClientModifyProfileForm detailForm = (ClientModifyProfileForm) form;
		UcMembers user = (UcMembers)request.getSession().getAttribute("CLIENT");
		
		try{
			
			UserDetail detail = clientModifyProfile.getUserDetail(detailForm.getId());
			detail.setBirthDay(detailForm.getBirthDay());
			detail.setBirthLock(detailForm.getBirthLock());
			detail.setBirthMonth(detailForm.getBirthMonth());
			detail.setBirthType(detailForm.getBirthType());
			detail.setBirthYear(detailForm.getBirthYear());
			detail.setCalling(detailForm.getCalling());
			detail.setCallingLock(detailForm.getCallingLock());
			detail.setDescription(detailForm.getDescription());
			detail.setEmail(detailForm.getEmail());
			detail.setEmailLock(detailForm.getEmailLock());
			detail.setHomeCityId(detailForm.getHomeCityId());
			detail.setHomeCityName(detailForm.getHomeCityName());
			detail.setHomeDistrictId(detailForm.getHomeDistrictId());
			detail.setHomeDistrictName(detailForm.getHomeDistrictName());
			detail.setHomeProvinceId(detailForm.getHomeProvinceId());
			detail.setHomeProvinceName(detailForm.getHomeProvinceName());
			detail.setHomeLock(detailForm.getHomeLock());
			
			detail.setLiveCityId(detailForm.getLiveCityId());
			detail.setLiveCityName(detailForm.getLiveCityName());
			detail.setLiveDistrictId(detailForm.getLiveDistrictId());
			detail.setLiveDistrictName(detailForm.getLiveDistrictName());
			detail.setLiveProvinceId(detailForm.getLiveProvinceId());
			detail.setLiveProvinceName(detailForm.getLiveProvinceName());
			detail.setLiveLock(detailForm.getLiveLock());
			
			detail.setMobile(detailForm.getMobile());
			detail.setMobileLock(detailForm.getMobileLock());
			detail.setMsn(detailForm.getMsn());
			detail.setMsnLock(detailForm.getMsnLock());
			detail.setPhone(detailForm.getPhone());
			detail.setPhoneLock(detailForm.getPhoneLock());
			detail.setQq(detailForm.getQq());
			detail.setQqLock(detailForm.getQqLock());
			detail.setScores(Integer.parseInt("0"));
			detail.setSex(detailForm.getSex());
			detail.setSexLock(detailForm.getSexLock());
			//detail.setWork(detailForm.getWork());
			//detail.setWorkLock(detailForm.getWorkLock());

			//clientModifyProfile.modifyUserDetail(detail);
			
			//user.setName(detailForm.getName());
			clientModifyProfile.modifyClient(user, detail);
			request.getSession().setAttribute("CLIENT", user);
			//System.out.println("User.detail.qq = " + detail.getQq());
			
			request.setAttribute("MESSAGE_INFO", "修改成功！");
			request.setAttribute("USER_DETAIL", detail);
			return mapping.findForward("modify");
		
		}catch( Exception e ){
			e.printStackTrace();
			return mapping.findForward("fail");
		}
	}
	
	
	public ActionForward modifypwd(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) {
 
		UcMembers user = (UcMembers)request.getSession().getAttribute("CLIENT");
		String oldpassword = request.getParameter("oldpassword");
		String newpassword = request.getParameter("newpassword");
		
		try{
			String md5Password = MD5.convert(MD5.convert(oldpassword) + user.getSalt()) ;
			//String md5Password = MD5.convert(oldpassword);
			if(md5Password.trim().equals(user.getPassword())) {
				user.setPassword(MD5.convert(newpassword));
				//userInfoManager.updateUcMember(user);
				request.getSession().setAttribute("CLIENT", user);
				request.setAttribute("MESSAGE_INFO", "修改成功！");
				return mapping.findForward("modifypwd");
			}
			else {
				request.setAttribute("MESSAGE_INFO", "您输入的旧密码有误！");
				return mapping.findForward("modifypwd");
			}
		
			
			
			
		
		}catch( Exception e ){
			e.printStackTrace();
			return mapping.findForward("fail");
		}
	}


	public UserInfoManager getUserInfoManager() {
		return userInfoManager;
	}


	public void setUserInfoManager(UserInfoManager userInfoManager) {
		this.userInfoManager = userInfoManager;
	}
	
}